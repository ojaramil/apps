<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MHM Mascota Multi - Veterinary Medical History">
    <title>MHM Mascota Multi - Historia M√©dica Veterinaria</title>

    <style>
        /* =============================================
   MHM MASCOTA - Historia M√©dica Veterinaria
   Estilo Premium UI
   ============================================= */
        :root {
            --primary-green-dark: #1b5e20;
            --primary-green: #388e3c;
            --primary-green-light: #66bb6a;
            --accent-orange: #ff7043;
            --accent-orange-dark: #e64a19;
            --accent-brown: #795548;
            --bg-gradient-start: #1b5e20;
            --bg-gradient-mid: #43a047;
            --bg-gradient-end: #81c784;
            --btn-gradient-start: #fff8e1;
            --btn-gradient-end: #ffcc80;
            --btn-border: #fb8c00;
            --tab-bg: #c8e6c9;
            --tab-active-bg: #e8f5e9;
            --tab-border: #66bb6a;
            --input-bg: #ffffff;
            --input-border: #a5d6a7;
            --input-shadow: rgba(0, 0, 0, 0.1);
            --text-dark: #1b5e20;
            --text-label: #2e7d32;
            --text-body: #333333;
            --font-main: 'Segoe UI', 'Roboto', Tahoma, sans-serif;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 20px;
            --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 16px rgba(0, 0, 0, 0.25);
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            /* Ajuste para iframe: scroll en el body, no height 100vh fijo */
            height: 100%;
            position: absolute;
            width: 100%;
            overflow-y: auto;
            color: var(--text-body);
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 40%, var(--bg-gradient-end) 100%);
            background-attachment: fixed;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse 80% 50% at 20% 80%, rgba(255, 255, 255, 0.12) 0%, transparent 50%),
                        radial-gradient(ellipse 60% 40% at 80% 30%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .mhm-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 15px;
            position: relative;
            z-index: 1;
            padding-bottom: 80px; /* Espacio para disclaimer footer */
        }

        /* HEADER */
        .mhm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .mhm-logo { display: flex; align-items: center; gap: 12px; }
        .mhm-logo-icon {
            width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;
        }
        .mhm-logo-paw {
            font-size: 3.5rem; color: var(--accent-orange);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: pawPulse 2s ease-in-out infinite;
        }
        @keyframes pawPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .mhm-logo-text { color: white; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); }
        .mhm-logo-title { font-size: 2.8rem; font-weight: bold; letter-spacing: -3px; margin: 0; line-height: 1; }
        .mhm-logo-subtitle { font-size: 0.9rem; font-style: italic; margin: 0; letter-spacing: 1px; color: #ffcc80; }

        /* BUTTONS */
        .mhm-header-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .mhm-btn {
            background: linear-gradient(180deg, var(--btn-gradient-start) 0%, var(--btn-gradient-end) 100%);
            border: 1px solid var(--btn-border);
            border-radius: var(--radius-md);
            padding: 10px 18px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #5d4037;
            cursor: pointer;
            text-align: center;
            min-width: 95px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }
        .mhm-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25); }
        .mhm-btn:active { transform: translateY(0); }
        .mhm-btn--exit { background: linear-gradient(180deg, #ffcdd2 0%, #ef9a9a 100%); border-color: #e57373; color: #b71c1c; }

        /* INFO STRIP */
        .mhm-info-strip {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-md);
            padding: 12px 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: var(--shadow-light);
            border-left: 4px solid var(--accent-orange);
        }
        .mhm-info-left { display: flex; flex-direction: column; gap: 4px; }
        .mhm-info-name { font-size: 1rem; font-weight: 600; color: var(--text-dark); }
        .mhm-info-pet { font-size: 1.1rem; font-weight: 700; color: var(--accent-orange-dark); }
        .mhm-info-date { font-size: 0.85rem; color: #666; }
        .mhm-info-disclaimer { font-size: 0.8rem; color: #555; text-align: right; }

        /* TABS */
        .mhm-nav-tabs {
            display: flex; gap: 3px; overflow-x: auto; padding-bottom: 0; margin-bottom: 0;
            -webkit-overflow-scrolling: touch; scrollbar-width: thin;
        }
        .mhm-tab {
            background: linear-gradient(180deg, #c8e6c9 0%, #a5d6a7 100%);
            border: 1px solid var(--tab-border); border-bottom: none;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            padding: 10px 16px; font-size: 0.75rem; font-weight: 600;
            color: var(--primary-green-dark); cursor: pointer; text-align: center;
            min-width: 90px; white-space: nowrap; flex-shrink: 0;
        }
        .mhm-tab.active {
            background: linear-gradient(180deg, #ffffff 0%, #e8f5e9 100%);
            border-bottom: 2px solid white; transform: translateY(2px); z-index: 10; font-weight: 700;
        }

        /* CONTENT */
        .mhm-content-panel {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            padding: 20px; min-height: 500px;
            box-shadow: var(--shadow-medium);
            border-top: 2px solid rgba(255, 255, 255, 0.6);
        }
        .mhm-tab-content { display: none; animation: fadeIn 0.3s ease; }
        .mhm-tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* FORMS */
        .mhm-section-title {
            color: var(--primary-green-dark); font-size: 1rem; font-weight: 700; text-transform: uppercase;
            margin: 0 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid var(--primary-green);
            display: flex; align-items: center; gap: 8px;
        }
        .mhm-section-title--orange { color: var(--accent-orange-dark); border-bottom-color: var(--accent-orange); }
        .mhm-form-row { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
        .mhm-form-group { display: flex; flex-direction: column; flex: 1; min-width: 120px; }
        .mhm-form-group--large { flex: 2; }
        .mhm-label { font-size: 0.7rem; font-weight: 600; color: var(--text-label); margin-bottom: 4px; }
        .mhm-input, .mhm-select, .mhm-textarea {
            background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 15px;
            padding: 8px 14px; font-size: 0.9rem; color: var(--text-body); width: 100%;
        }
        .mhm-textarea { border-radius: var(--radius-md); min-height: 80px; resize: vertical; }
        .mhm-radio-group { display: flex; gap: 15px; align-items: center; font-size: 0.8rem; flex-wrap: wrap; }
        .mhm-card {
            background: rgba(255, 255, 255, 0.85); border-radius: var(--radius-md); padding: 18px;
            margin-bottom: 15px; box-shadow: var(--shadow-light); border-left: 5px solid var(--primary-green);
        }
        
        /* HEADER CONTROLS */
        .mhm-header-controls { display: flex; align-items: center; gap: 15px; }
        .pet-selector-container { position: relative; }
        .pet-selector-btn {
            background: linear-gradient(180deg, #ffffff 0%, #e8f5e9 100%);
            border: 2px solid var(--primary-green); border-radius: var(--radius-lg);
            padding: 10px 16px; font-weight: 600; color: var(--primary-green-dark);
            cursor: pointer; display: flex; align-items: center; gap: 8px; min-width: 180px;
        }
        .pet-selector-dropdown {
            position: absolute; top: 100%; left: 0; background: white; border: 2px solid var(--primary-green);
            border-radius: var(--radius-md); min-width: 250px; z-index: 100;
        }
        .pet-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .pet-item:hover { background: #e8f5e9; }
        .hidden { display: none !important; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .mhm-header { flex-direction: column; text-align: center; }
            .mhm-form-row { flex-direction: column; }
            .mhm-logo-title { font-size: 2rem; }
        }
    </style>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="mhm-container">

        <header class="mhm-header">
            <div class="mhm-logo">
                <div class="mhm-logo-icon"><i class="fas fa-paw mhm-logo-paw"></i></div>
                <div class="mhm-logo-text">
                    <h1 class="mhm-logo-title">MHM</h1>
                    <p class="mhm-logo-subtitle" data-i18n="appSubtitle">Mi Historia M√©dica</p>
                </div>
            </div>

            <div class="mhm-header-controls">
                <div class="pet-selector-container">
                    <button class="pet-selector-btn" id="pet-selector-btn">
                        <i class="fas fa-paw"></i> <span id="current-pet-name">Max</span> <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="pet-selector-dropdown hidden" id="pet-selector-dropdown">
                        <div class="pet-list" id="pet-list"></div>
                        <button class="mhm-btn" id="pet-add-btn" style="width:100%; border-radius:0;">+ Nueva Mascota</button>
                    </div>
                </div>
                <div style="background:rgba(255,255,255,0.3); border-radius:20px; padding:3px;">
                    <button class="mhm-btn lang-btn active" data-lang="es" style="min-width:40px; padding:5px;">ES</button>
                    <button class="mhm-btn lang-btn" data-lang="en" style="min-width:40px; padding:5px;">EN</button>
                </div>
            </div>

            <div class="mhm-header-buttons">
                <button class="mhm-btn" id="btn-save"><i class="fas fa-save"></i><br><span data-i18n="save">Guardar</span></button>
                <button class="mhm-btn" id="btn-print"><i class="fas fa-print"></i><br><span data-i18n="print">Imprimir</span></button>
            </div>
        </header>

        <div class="mhm-info-strip">
            <div class="mhm-info-left">
                <div class="mhm-info-pet" id="info-pet-name"><i class="fas fa-paw"></i> <span id="info-pet-display">Cargando...</span></div>
                <div class="mhm-info-name" id="info-owner">Propietario: ‚Äî</div>
                <div class="mhm-info-date" id="info-date">√öltima actualizaci√≥n: ‚Äî</div>
            </div>
            <div class="mhm-info-disclaimer">
                </div>
        </div>

        <nav class="mhm-nav-tabs" id="nav-tabs">
            <div class="mhm-tab active" data-tab="pet-info"><i class="fas fa-id-card"></i><br>Mascota</div>
            <div class="mhm-tab" data-tab="owner"><i class="fas fa-user"></i><br>Propietario</div>
            <div class="mhm-tab" data-tab="pathologies"><i class="fas fa-notes-medical"></i><br>Historia</div>
            <div class="mhm-tab" data-tab="meds"><i class="fas fa-pills"></i><br>Medicinas</div>
            <div class="mhm-tab" data-tab="vaccines"><i class="fas fa-syringe"></i><br>Vacunas</div>
        </nav>

        <main class="mhm-content-panel">

            <div id="tab-pet-info" class="mhm-tab-content active">
                <h2 class="mhm-section-title"><i class="fas fa-paw"></i> Informaci√≥n de la Mascota</h2>
                
                <div class="mhm-form-row">
                    <div class="mhm-form-group" style="flex: 0 0 100px; align-items: center; justify-content:center;">
                        <div style="width:80px; height:80px; background:#e8f5e9; border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px dashed #388e3c;">
                            <i class="fas fa-camera" style="color:#388e3c; font-size:1.5rem;"></i>
                        </div>
                        <small style="font-size:0.6rem; text-align:center; color:#666;">(Sin foto)</small>
                    </div>

                    <div class="mhm-form-group mhm-form-group--large">
                        <label class="mhm-label">Nombre</label>
                        <input type="text" class="mhm-input" id="pet-name" style="font-weight:bold; font-size:1.2rem;">
                    </div>
                    <div class="mhm-form-group">
                        <label class="mhm-label">Especie</label>
                        <select class="mhm-select" id="pet-species-select">
                            <option value="perro">Perro</option>
                            <option value="gato">Gato</option>
                            <option value="ave">Ave</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                </div>

                <div class="mhm-form-row">
                    <div class="mhm-form-group"><label class="mhm-label">Raza</label><input type="text" class="mhm-input" id="pet-breed"></div>
                    <div class="mhm-form-group"><label class="mhm-label">Color</label><input type="text" class="mhm-input" id="pet-color"></div>
                    <div class="mhm-form-group"><label class="mhm-label">Nacimiento</label><input type="date" class="mhm-input" id="pet-dob"></div>
                </div>
                
                <div class="mhm-form-row">
                    <div class="mhm-form-group"><label class="mhm-label">Microchip</label><input type="text" class="mhm-input" id="pet-microchip"></div>
                    <div class="mhm-form-group"><label class="mhm-label">Peso (kg)</label><input type="number" class="mhm-input" id="pet-weight"></div>
                    <div class="mhm-form-group">
                        <label class="mhm-label">Sexo</label>
                        <div class="mhm-radio-group">
                            <label><input type="radio" name="pet-sex" value="macho"> Macho</label>
                            <label><input type="radio" name="pet-sex" value="hembra"> Hembra</label>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-owner" class="mhm-tab-content">
                <h2 class="mhm-section-title"><i class="fas fa-user"></i> Datos del Propietario</h2>
                <div class="mhm-form-row">
                    <div class="mhm-form-group mhm-form-group--large"><label class="mhm-label">Nombre Completo</label><input type="text" class="mhm-input" id="owner-name"></div>
                    <div class="mhm-form-group"><label class="mhm-label">Tel√©fono</label><input type="tel" class="mhm-input" id="owner-phone"></div>
                </div>
                <div class="mhm-form-group"><label class="mhm-label">Direcci√≥n</label><input type="text" class="mhm-input" id="owner-address"></div>
                <div class="mhm-form-group"><label class="mhm-label">Email</label><input type="email" class="mhm-input" id="owner-email"></div>
            </div>

            <div id="tab-pathologies" class="mhm-tab-content">
                <h2 class="mhm-section-title"><i class="fas fa-notes-medical"></i> Historia Cl√≠nica</h2>
                <div class="mhm-card">
                    <label class="mhm-label">Notas M√©dicas / Antecedentes</label>
                    <textarea class="mhm-textarea" id="medical-notes" style="height:200px;" placeholder="Escribe aqu√≠ los antecedentes, cirug√≠as previas y condiciones cr√≥nicas..."></textarea>
                </div>
            </div>

            <div id="tab-meds" class="mhm-tab-content">
                <h2 class="mhm-section-title"><i class="fas fa-pills"></i> Medicamentos Activos</h2>
                <textarea class="mhm-textarea" id="meds-notes" style="height:150px;" placeholder="Lista de medicamentos actuales (Dosis y Frecuencia)..."></textarea>
            </div>

            <div id="tab-vaccines" class="mhm-tab-content">
                <h2 class="mhm-section-title"><i class="fas fa-syringe"></i> Vacunas</h2>
                <textarea class="mhm-textarea" id="vaccine-notes" style="height:150px;" placeholder="Registro de vacunas y fechas..."></textarea>
            </div>

        </main>
    </div>

    <script>
        // --- GESTOR DE ALMACENAMIENTO GOOGLE SHEETS ---
        class GoogleSheetsStorageManager {
            constructor() {
                // ======================================================
                // PEGA AQUI TU URL DE GOOGLE APPS SCRIPT (PASO 1)
                // ======================================================
                this.scriptURL = "https://script.google.com/macros/s/AKfycbxIqeThUiJhj298q3zbcOhc8VWiT5yvKlBoxwGqLQTwMEnrIXW5DH9Jhd2LuLS5rddaiA/exec"; 
                // ======================================================

                // Intentar recuperar ID localmente (si Appily no lo borr√≥)
                this.userId = localStorage.getItem('mhm_cloud_id');
                
                if (!this.userId) {
                    // Generar ID √∫nico corto (Ej: MHM-9A2)
                    this.userId = 'MHM-' + Math.random().toString(36).substr(2, 4).toUpperCase();
                    localStorage.setItem('mhm_cloud_id', this.userId);
                    
                    // Alerta inicial
                    setTimeout(() => {
                        alert('‚òÅÔ∏è ID DE RESPALDO: ' + this.userId + '\n\nGuarda este c√≥digo. Si la app se reinicia, √∫salo para recuperar tus datos.');
                    }, 1000);
                }
                
                console.log("üÜî Usuario:", this.userId);
                setTimeout(() => this.showUserIdInFooter(), 500);
                this.isReady = true;
            }

            async waitForReady() { return true; }

            // Mostrar el ID y bot√≥n de recuperar en el footer
            showUserIdInFooter() {
                const footer = document.querySelector('.mhm-info-disclaimer');
                if(footer) {
                    const idDiv = document.createElement('div');
                    idDiv.style.cssText = "margin-top:10px; color:#e64a19; font-weight:bold; font-size:0.9rem; padding:5px; background:#fff3e0; border-radius:4px; text-align:center;";
                    idDiv.innerHTML = `ID Nube: ${this.userId} <button onclick="recoverDataPrompt()" style="margin-left:10px; padding:4px 8px; cursor:pointer; background:#333; color:white; border:none; border-radius:4px;">üîÑ Cargar Datos Antiguos</button>`;
                    footer.appendChild(idDiv);
                }

                window.recoverDataPrompt = () => {
                    const code = prompt("Introduce tu ID anterior (Ej: MHM-X9X9):", "");
                    if (code && code.trim().length > 3) {
                        localStorage.setItem('mhm_cloud_id', code.trim().toUpperCase());
                        location.reload();
                    }
                };
            }

            // LEER (GET)
            async getItem(key) {
                if (key.includes('pets-data')) {
                    try {
                        const response = await fetch(this.scriptURL + "?action=read&id=" + this.userId);
                        const data = await response.json();
                        return data;
                    } catch (e) {
                        console.error("Error Sheets:", e);
                        return null;
                    }
                }
                return localStorage.getItem(key);
            }

            // GUARDAR (POST)
            async setItem(key, value) {
                if (key.includes('pets-data')) {
                    try {
                        let dataToSend = value;
                        try { if (typeof value === 'string') dataToSend = JSON.parse(value); } catch(e) {}

                        const payload = { id: this.userId, data: dataToSend };

                        // 'no-cors' permite enviar datos sin esperar respuesta JSON (fire and forget)
                        await fetch(this.scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify(payload)
                        });
                        return true;
                    } catch (e) { return false; }
                }
                localStorage.setItem(key, value);
                return true;
            }
        }

        // --- GESTOR DE MASCOTAS ---
        class MultiPetManager {
            constructor() {
                this.pets = [];
                this.currentPetId = null;
                this.storage = new GoogleSheetsStorageManager();
                this.init();
            }

            async init() {
                const savedData = await this.storage.getItem('mhm-pets-data');
                if (savedData && Array.isArray(savedData) && savedData.length > 0) {
                    this.pets = savedData;
                } else {
                    this.addPet("Max"); // Default
                }
                this.currentPetId = this.pets[0].id;
                this.renderUI();
            }

            addPet(name) {
                if (this.pets.length >= 5) return alert("M√°ximo 5 mascotas");
                const newPet = {
                    id: 'pet_' + Date.now(),
                    name: name,
                    data: {
                        petInfo: { name: name, species: 'perro', breed:'', color:'', dob:'', microchip:'', weight:'', sex:'' },
                        ownerInfo: { name:'', phone:'', address:'', email:'' },
                        notes: { medical:'', meds:'', vaccines:'' }
                    }
                };
                this.pets.push(newPet);
                this.save();
                this.currentPetId = newPet.id;
                this.renderUI();
            }

            deletePet(id) {
                if (this.pets.length <= 1) return alert("No puedes borrar la √∫nica mascota");
                if(confirm("¬øBorrar mascota?")) {
                    this.pets = this.pets.filter(p => p.id !== id);
                    this.currentPetId = this.pets[0].id;
                    this.save();
                    this.renderUI();
                }
            }

            switchPet(id) {
                this.currentPetId = id;
                this.renderUI();
            }

            getCurrentPet() { return this.pets.find(p => p.id === this.currentPetId); }

            updateCurrentPet(formData) {
                const pet = this.getCurrentPet();
                if(pet) {
                    // Merge simple
                    if(formData.petInfo) Object.assign(pet.data.petInfo, formData.petInfo);
                    if(formData.ownerInfo) Object.assign(pet.data.ownerInfo, formData.ownerInfo);
                    if(formData.notes) Object.assign(pet.data.notes, formData.notes);
                    pet.name = pet.data.petInfo.name; // Update display name
                    this.save();
                    this.updateHeader();
                }
            }

            save() {
                this.storage.setItem('mhm-pets-data', this.pets);
            }

            renderUI() {
                this.updateHeader();
                this.renderPetList();
                this.fillForms();
            }

            updateHeader() {
                const pet = this.getCurrentPet();
                document.getElementById('current-pet-name').innerText = pet.name;
                document.getElementById('info-pet-display').innerText = pet.name;
                document.getElementById('info-owner').innerText = "Propietario: " + (pet.data.ownerInfo.name || "‚Äî");
            }

            renderPetList() {
                const list = document.getElementById('pet-list');
                list.innerHTML = '';
                this.pets.forEach(pet => {
                    const div = document.createElement('div');
                    div.className = 'pet-item';
                    div.innerHTML = `<span>${pet.name}</span> ${this.pets.length > 1 ? '<i class="fas fa-trash"></i>' : ''}`;
                    div.onclick = (e) => {
                        if(e.target.classList.contains('fa-trash')) {
                            this.deletePet(pet.id);
                        } else {
                            this.switchPet(pet.id);
                            document.getElementById('pet-selector-dropdown').classList.add('hidden');
                        }
                    };
                    list.appendChild(div);
                });
            }

            fillForms() {
                const d = this.getCurrentPet().data;
                setVal('pet-name', d.petInfo.name);
                setVal('pet-species-select', d.petInfo.species);
                setVal('pet-breed', d.petInfo.breed);
                setVal('pet-color', d.petInfo.color);
                setVal('pet-dob', d.petInfo.dob);
                setVal('pet-microchip', d.petInfo.microchip);
                setVal('pet-weight', d.petInfo.weight);
                setRadio('pet-sex', d.petInfo.sex);

                setVal('owner-name', d.ownerInfo.name);
                setVal('owner-phone', d.ownerInfo.phone);
                setVal('owner-address', d.ownerInfo.address);
                setVal('owner-email', d.ownerInfo.email);

                setVal('medical-notes', d.notes.medical);
                setVal('meds-notes', d.notes.meds);
                setVal('vaccine-notes', d.notes.vaccines);
            }
        }

        // --- UI LOGIC ---
        const petManager = new MultiPetManager();

        // Helper functions
        function setVal(id, val) { const el = document.getElementById(id); if(el) el.value = val || ''; }
        function getVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        function setRadio(name, val) { 
            const el = document.querySelector(`input[name="${name}"][value="${val}"]`);
            if(el) el.checked = true;
        }
        function getRadio(name) {
            const el = document.querySelector(`input[name="${name}"]:checked`);
            return el ? el.value : '';
        }

        // Auto Save Logic (Debounce)
        let timeout;
        document.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                const data = {
                    petInfo: {
                        name: getVal('pet-name'),
                        species: getVal('pet-species-select'),
                        breed: getVal('pet-breed'),
                        color: getVal('pet-color'),
                        dob: getVal('pet-dob'),
                        microchip: getVal('pet-microchip'),
                        weight: getVal('pet-weight'),
                        sex: getRadio('pet-sex')
                    },
                    ownerInfo: {
                        name: getVal('owner-name'),
                        phone: getVal('owner-phone'),
                        address: getVal('owner-address'),
                        email: getVal('owner-email')
                    },
                    notes: {
                        medical: getVal('medical-notes'),
                        meds: getVal('meds-notes'),
                        vaccines: getVal('vaccine-notes')
                    }
                };
                petManager.updateCurrentPet(data);
                const dateEl = document.getElementById('info-date');
                if(dateEl) dateEl.innerText = "Guardando...";
                setTimeout(() => { if(dateEl) dateEl.innerText = "Guardado en Nube"; }, 1000);
            }, 1000);
        });

        // Tabs
        document.querySelectorAll('.mhm-tab').forEach(t => {
            t.onclick = () => {
                document.querySelectorAll('.mhm-tab').forEach(x => x.classList.remove('active'));
                document.querySelectorAll('.mhm-tab-content').forEach(x => x.classList.remove('active'));
                t.classList.add('active');
                document.getElementById('tab-' + t.dataset.tab).classList.add('active');
            }
        });

        // Add Pet Btn
        document.getElementById('pet-add-btn').onclick = () => {
            const name = prompt("Nombre de la nueva mascota:");
            if(name) petManager.addPet(name);
        };

        // Selector Toggle
        document.getElementById('pet-selector-btn').onclick = (e) => {
            e.stopPropagation();
            document.getElementById('pet-selector-dropdown').classList.toggle('hidden');
        };
        document.onclick = () => document.getElementById('pet-selector-dropdown').classList.add('hidden');

        // Save manual
        document.getElementById('btn-save').onclick = () => {
            alert("Los datos se guardan autom√°ticamente en Google Sheets.");
        };
        document.getElementById('btn-print').onclick = () => window.print();

    </script>
</body>
</html>
