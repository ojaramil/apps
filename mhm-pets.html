<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MHM Mascota Cloud</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #2e7d32; --light: #e8f5e9; --accent: #ff6f00; --text: #333;
            --bg-grad: linear-gradient(135deg, #1b5e20 0%, #4caf50 100%);
        }
        body {
            font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; 
            background: var(--bg-grad); color: var(--text);
            height: 100%; position: absolute; width: 100%; overflow-y: auto;
        }
        .app-container {
            max-width: 800px; margin: 0 auto; padding: 15px; 
            padding-bottom: 100px; /* Footer space */
        }
        /* Header */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            color: white; margin-bottom: 15px;
        }
        .header h1 { margin: 0; font-size: 1.5rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .btn-mini {
            background: rgba(255,255,255,0.2); border: 1px solid white; color: white;
            padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; cursor: pointer;
        }
        /* Cards & Inputs */
        .card {
            background: rgba(255,255,255,0.95); border-radius: 12px; padding: 15px;
            margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .form-group { margin-bottom: 12px; }
        .label { display: block; font-size: 0.8rem; font-weight: bold; color: var(--primary); margin-bottom: 4px; }
        .input {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;
            font-size: 1rem; box-sizing: border-box;
        }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        /* Photo Upload */
        .photo-area {
            width: 120px; height: 120px; margin: 0 auto 15px; position: relative;
            border-radius: 50%; border: 3px solid var(--primary); background: #f1f8e9;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .photo-area img { width: 100%; height: 100%; object-fit: cover; }
        .photo-label {
            position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.5);
            color: white; font-size: 0.6rem; text-align: center; padding: 2px 0;
        }
        /* Footer / Recovery */
        .recovery-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #fff3e0;
            padding: 10px; text-align: center; border-top: 2px solid var(--accent);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100;
        }
        .id-badge { font-weight: bold; color: var(--accent); font-size: 1.1rem; }
        .btn-recover {
            background: #333; color: white; border: none; padding: 5px 12px;
            border-radius: 4px; margin-left: 10px; cursor: pointer;
        }
        /* Spinner */
        .spinner { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); align-items: center; justify-content: center; }
        .saving-indicator {
            position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.7);
            color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem;
            display: none; z-index: 200;
        }
    </style>
</head>
<body>

    <div id="save-indicator" class="saving-indicator">‚òÅÔ∏è Guardando...</div>

    <div class="app-container">
        
        <div class="header">
            <div>
                <h1>MHM Mascota</h1>
                <small style="opacity:0.8">Cloud Edition</small>
            </div>
            <button class="btn-mini" onclick="window.print()"><i class="fas fa-print"></i> PDF</button>
        </div>

        <div class="card">
            <div class="photo-area" id="photo-trigger">
                <i class="fas fa-camera fa-2x" style="color: #ccc;" id="photo-icon"></i>
                <img id="pet-photo-preview" style="display:none;">
                <div class="photo-label">CAMBIAR FOTO</div>
                <div class="spinner" id="photo-spinner"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
            </div>
            <input type="file" id="file-input" accept="image/*" style="display:none;">

            <div class="form-group">
                <span class="label">Nombre de la Mascota</span>
                <input type="text" class="input" id="pet-name" placeholder="Ej: Max" style="font-size:1.2rem; font-weight:bold; text-align:center;">
            </div>
            
            <div class="row">
                <div class="col">
                    <span class="label">Especie</span>
                    <select class="input" id="pet-species">
                        <option value="Perro">Perro</option>
                        <option value="Gato">Gato</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="col">
                    <span class="label">Raza</span>
                    <input type="text" class="input" id="pet-breed">
                </div>
            </div>
            
            <div class="row" style="margin-top:10px;">
                <div class="col">
                    <span class="label">Peso (kg)</span>
                    <input type="number" class="input" id="pet-weight">
                </div>
                <div class="col">
                    <span class="label">F. Nacimiento</span>
                    <input type="date" class="input" id="pet-dob">
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0; color:var(--primary); font-size:1rem;"><i class="fas fa-user"></i> Propietario</h3>
            <div class="form-group">
                <span class="label">Nombre Propietario</span>
                <input type="text" class="input" id="owner-name">
            </div>
            <div class="form-group">
                <span class="label">Tel√©fono / Celular</span>
                <input type="tel" class="input" id="owner-phone">
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0; color:var(--primary); font-size:1rem;"><i class="fas fa-notes-medical"></i> Historia M√©dica</h3>
            <div class="form-group">
                <span class="label">Notas Cl√≠nicas / Vacunas / Alergias</span>
                <textarea class="input" id="medical-notes" style="height:150px; resize:vertical;"></textarea>
            </div>
        </div>

    </div>

    <div class="recovery-bar">
        <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">SI LA APP SE REINICIA, USA ESTE C√ìDIGO:</div>
        <span id="user-id-display" class="id-badge">...</span>
        <button class="btn-recover" onclick="recoverData()">üîÑ Recuperar Datos</button>
    </div>

    <script>
        // ==========================================
        // CONFIGURACI√ìN
        // ==========================================
        const CONFIG = {
            // PEGA TU URL DE APPS SCRIPT AQU√ç (La que termina en /exec)
            scriptURL: "https://script.google.com/macros/s/PEGA_AQUI_TU_URL_LARGA/exec" 
        };

        // ==========================================
        // GESTI√ìN DE ESTADO (DATA MANAGER)
        // ==========================================
        const AppState = {
            userId: null,
            data: {
                pet: { name: '', species: 'Perro', breed: '', weight: '', dob: '', photoUrl: '' },
                owner: { name: '', phone: '' },
                medical: ''
            },
            
            init() {
                // 1. Obtener o crear ID
                this.userId = localStorage.getItem('mhm_cloud_id');
                if (!this.userId) {
                    this.userId = 'MHM-' + Math.random().toString(36).substr(2, 4).toUpperCase();
                    localStorage.setItem('mhm_cloud_id', this.userId);
                    alert("‚òÅÔ∏è NUEVO C√ìDIGO DE NUBE: " + this.userId + "\n\nGu√°rdalo. Lo necesitar√°s para recuperar tus datos si la app se reinicia.");
                }
                document.getElementById('user-id-display').innerText = this.userId;

                // 2. Intentar cargar datos de la nube
                this.loadFromCloud();
            },

            async loadFromCloud() {
                console.log("‚è≥ Cargando datos...");
                try {
                    const res = await fetch(`${CONFIG.scriptURL}?action=read&id=${this.userId}`);
                    const json = await res.json();
                    
                    if (json) {
                        this.data = json; // Actualizar estado local
                        UI.render(this.data); // Pintar en pantalla
                        console.log("‚úÖ Datos cargados");
                    }
                } catch (e) {
                    console.error("Error cargando:", e);
                }
            },

            async saveToCloud() {
                const indicator = document.getElementById('save-indicator');
                indicator.style.display = 'block';
                
                try {
                    const payload = { id: this.userId, data: this.data };
                    
                    await fetch(CONFIG.scriptURL, {
                        method: 'POST',
                        mode: 'no-cors', // Importante para Apps Script
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(payload)
                    });
                    
                    setTimeout(() => { indicator.style.display = 'none'; }, 1000);
                    console.log("‚úÖ Guardado auto-exitoso");
                } catch (e) {
                    console.error("Error guardando:", e);
                    indicator.innerText = "Error conexi√≥n";
                }
            },

            async uploadPhoto(file) {
                const spinner = document.getElementById('photo-spinner');
                spinner.style.display = 'flex';

                try {
                    // 1. Comprimir imagen (Vital para no saturar Apps Script)
                    const base64 = await UI.compressImage(file, 600); // Max 600px ancho

                    // 2. Preparar payload
                    const payload = {
                        action: "uploadImage",
                        image: base64
                    };

                    // 3. Enviar (Usamos CORS mode para recibir respuesta)
                    const res = await fetch(CONFIG.scriptURL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(payload)
                    });

                    const json = await res.json();

                    if (json.status === "success") {
                        this.data.pet.photoUrl = json.url;
                        UI.render(this.data); // Mostrar foto nueva
                        this.saveToCloud(); // Guardar la URL en el JSON del usuario
                    } else {
                        throw new Error(json.message);
                    }

                } catch (e) {
                    alert("Error subiendo foto: " + e.message);
                } finally {
                    spinner.style.display = 'none';
                }
            }
        };

        // ==========================================
        // INTERFAZ DE USUARIO (UI)
        // ==========================================
        const UI = {
            render(data) {
                // Llenar campos
                setVal('pet-name', data.pet.name);
                setVal('pet-species', data.pet.species);
                setVal('pet-breed', data.pet.breed);
                setVal('pet-weight', data.pet.weight);
                setVal('pet-dob', data.pet.dob);
                setVal('owner-name', data.owner.name);
                setVal('owner-phone', data.owner.phone);
                setVal('medical-notes', data.medical);

                // Mostrar foto si existe
                const img = document.getElementById('pet-photo-preview');
                const icon = document.getElementById('photo-icon');
                if (data.pet.photoUrl) {
                    img.src = data.pet.photoUrl;
                    img.style.display = 'block';
                    icon.style.display = 'none';
                } else {
                    img.style.display = 'none';
                    icon.style.display = 'block';
                }
            },

            // Funci√≥n de compresi√≥n de imagen
            compressImage(file, maxWidth) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width;
                            let h = img.height;
                            if (w > maxWidth) { h *= maxWidth/w; w = maxWidth; }
                            canvas.width = w; canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);
                            resolve(canvas.toDataURL('image/jpeg', 0.7)); // Calidad 70%
                        };
                    };
                });
            }
        };

        // Helpers
        function setVal(id, val) { 
            const el = document.getElementById(id); 
            if (el) el.value = val || ''; 
        }

        // ==========================================
        // EVENTOS
        // ==========================================
        
        // 1. Auto-Guardado (Debounce)
        let timeout;
        document.addEventListener('input', (e) => {
            if (e.target.type === 'file') return; // Ignorar input file
            
            // Actualizar estado local
            if (e.target.id === 'pet-name') AppState.data.pet.name = e.target.value;
            if (e.target.id === 'pet-species') AppState.data.pet.species = e.target.value;
            if (e.target.id === 'pet-breed') AppState.data.pet.breed = e.target.value;
            if (e.target.id === 'pet-weight') AppState.data.pet.weight = e.target.value;
            if (e.target.id === 'pet-dob') AppState.data.pet.dob = e.target.value;
            if (e.target.id === 'owner-name') AppState.data.owner.name = e.target.value;
            if (e.target.id === 'owner-phone') AppState.data.owner.phone = e.target.value;
            if (e.target.id === 'medical-notes') AppState.data.medical = e.target.value;

            // Esperar a que el usuario deje de escribir para guardar en nube
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                AppState.saveToCloud();
            }, 1500);
        });

        // 2. Manejo de Foto
        document.getElementById('photo-trigger').onclick = () => {
            document.getElementById('file-input').click();
        };

        document.getElementById('file-input').onchange = (e) => {
            if (e.target.files && e.target.files[0]) {
                AppState.uploadPhoto(e.target.files[0]);
            }
        };

        // 3. Recuperar Datos
        window.recoverData = () => {
            const oldId = prompt("Ingresa tu ID de Nube anterior:", "");
            if (oldId && oldId.length > 3) {
                localStorage.setItem('mhm_cloud_id', oldId.trim().toUpperCase());
                location.reload();
            }
        };

        // INICIAR
        AppState.init();

    </script>
</body>
</html>
