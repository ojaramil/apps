<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MHM Mascota Multi - Veterinary Medical History">
    <title>MHM Mascota Multi - Cloud Edition</title>

    <style>
        /* =============================================
           MHM MASCOTA - Estilos Originales Premium
           ============================================= */
        :root {
            --primary-green-dark: #1b5e20;
            --primary-green: #388e3c;
            --primary-green-light: #66bb6a;
            --accent-orange: #ff7043;
            --accent-orange-dark: #e64a19;
            --accent-brown: #795548;
            --bg-gradient-start: #1b5e20;
            --bg-gradient-mid: #43a047;
            --bg-gradient-end: #81c784;
            --btn-gradient-start: #fff8e1;
            --btn-gradient-end: #ffcc80;
            --btn-border: #fb8c00;
            --tab-bg: #c8e6c9;
            --tab-active-bg: #e8f5e9;
            --tab-border: #66bb6a;
            --input-bg: #ffffff;
            --input-border: #a5d6a7;
            --input-shadow: rgba(0, 0, 0, 0.1);
            --text-dark: #1b5e20;
            --text-label: #2e7d32;
            --text-body: #333333;
            --font-main: 'Segoe UI', 'Roboto', Tahoma, sans-serif;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 16px rgba(0, 0, 0, 0.25);
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            margin: 0; padding: 0;
            /* Scroll fix para iframes */
            height: 100%; position: absolute; width: 100%; overflow-y: auto;
            color: var(--text-body);
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 40%, var(--bg-gradient-end) 100%);
            background-attachment: fixed;
        }

        /* Container */
        .mhm-container { max-width: 1280px; margin: 0 auto; padding: 15px; padding-bottom: 80px; position: relative; z-index: 1; }

        /* Header */
        .mhm-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 10px; flex-wrap: wrap; gap: 15px; }
        .mhm-logo { display: flex; align-items: center; gap: 12px; }
        .mhm-logo-icon { width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; }
        .mhm-logo-paw { font-size: 3.5rem; color: var(--accent-orange); text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); animation: pawPulse 2s ease-in-out infinite; }
        @keyframes pawPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .mhm-logo-text { color: white; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); }
        .mhm-logo-title { font-size: 2.8rem; font-weight: bold; letter-spacing: -3px; margin: 0; line-height: 1; }
        .mhm-logo-subtitle { font-size: 0.9rem; font-style: italic; margin: 0; letter-spacing: 1px; color: #ffcc80; }

        /* Buttons & Header Controls */
        .mhm-header-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .mhm-btn {
            background: linear-gradient(180deg, var(--btn-gradient-start) 0%, var(--btn-gradient-end) 100%);
            border: 1px solid var(--btn-border); border-radius: var(--radius-md); padding: 10px 18px;
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: #5d4037; cursor: pointer;
            text-align: center; min-width: 95px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transition: all 0.2s ease;
        }
        .mhm-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25); }
        .mhm-btn--exit { background: linear-gradient(180deg, #ffcdd2 0%, #ef9a9a 100%); border-color: #e57373; color: #b71c1c; }

        /* Pet Selector */
        .mhm-header-controls { display: flex; align-items: center; gap: 15px; }
        .pet-selector-container { position: relative; }
        .pet-selector-btn {
            background: linear-gradient(180deg, #ffffff 0%, #e8f5e9 100%);
            border: 2px solid var(--primary-green); border-radius: var(--radius-lg);
            padding: 10px 16px; font-size: 0.9rem; font-weight: 600; color: var(--primary-green-dark);
            cursor: pointer; display: flex; align-items: center; gap: 8px; min-width: 180px; box-shadow: var(--shadow-light);
        }
        .pet-selector-dropdown {
            position: absolute; top: 100%; left: 0; background: white; border: 2px solid var(--primary-green);
            border-radius: var(--radius-md); box-shadow: var(--shadow-heavy); min-width: 250px; z-index: 1000;
        }
        .pet-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .pet-item:hover { background: #e8f5e9; }
        .pet-item.active { background: #c8e6c9; font-weight: 700; }
        .pet-add-btn { width: 100%; background: #fff3e0; border: none; padding: 12px; cursor: pointer; color: var(--accent-orange-dark); font-weight: bold;}

        /* Info Strip */
        .mhm-info-strip {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: var(--radius-md);
            padding: 12px 20px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; box-shadow: var(--shadow-light); border-left: 4px solid var(--accent-orange);
        }
        .mhm-info-pet { font-size: 1.1rem; font-weight: 700; color: var(--accent-orange-dark); }
        .mhm-info-disclaimer { font-size: 0.8rem; color: #555; text-align: right; }

        /* Tabs & Content */
        .mhm-nav-tabs { display: flex; gap: 3px; overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 0; }
        .mhm-tab {
            background: linear-gradient(180deg, #c8e6c9 0%, #a5d6a7 100%); border: 1px solid var(--tab-border); border-bottom: none;
            border-radius: var(--radius-md) var(--radius-md) 0 0; padding: 10px 16px; font-size: 0.75rem; font-weight: 600;
            color: var(--primary-green-dark); cursor: pointer; text-align: center; min-width: 90px;
        }
        .mhm-tab.active { background: linear-gradient(180deg, #ffffff 0%, #e8f5e9 100%); border-bottom: 2px solid white; transform: translateY(2px); z-index: 10; font-weight: 700; }
        .mhm-content-panel {
            background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(12px); border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            padding: 20px; min-height: 500px; box-shadow: var(--shadow-medium); border-top: 2px solid rgba(255, 255, 255, 0.6);
        }
        .mhm-tab-content { display: none; }
        .mhm-tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Forms */
        .mhm-section-title {
            color: var(--primary-green-dark); font-size: 1rem; font-weight: 700; text-transform: uppercase;
            margin: 0 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid var(--primary-green);
        }
        .mhm-form-row { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
        .mhm-form-group { display: flex; flex-direction: column; flex: 1; min-width: 120px; }
        .mhm-input, .mhm-select, .mhm-textarea {
            background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 15px;
            padding: 8px 14px; font-size: 0.9rem; width: 100%;
        }
        .mhm-card { background: rgba(255, 255, 255, 0.85); border-radius: var(--radius-md); padding: 18px; margin-bottom: 15px; border-left: 5px solid var(--primary-green); }
        
        /* Photo styles */
        .pet-photo-container {
            width: 150px; height: 150px; border: 3px dashed #a5d6a7; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.8);
            cursor: pointer; overflow: hidden; position: relative;
        }
        .loading-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center;
        }
        .hidden { display: none !important; }

        /* Responsive */
        @media (max-width: 768px) {
            .mhm-header { flex-direction: column; text-align: center; }
            .mhm-form-row { flex-direction: column; }
        }
    </style>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="mhm-container">

        <header class="mhm-header">
            <div class="mhm-logo">
                <div class="mhm-logo-icon"><i class="fas fa-paw mhm-logo-paw"></i></div>
                <div class="mhm-logo-text">
                    <h1 class="mhm-logo-title">MHM</h1>
                    <p class="mhm-logo-subtitle">Mi Historia M√©dica - Mascota</p>
                </div>
            </div>

            <div class="mhm-header-controls">
                <div class="pet-selector-container">
                    <button class="pet-selector-btn" id="pet-selector-btn">
                        <i class="fas fa-paw"></i> <span id="current-pet-name">Max</span> <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="pet-selector-dropdown hidden" id="pet-selector-dropdown">
                        <div id="pet-list"></div>
                        <button class="pet-add-btn" id="pet-add-btn"><i class="fas fa-plus-circle"></i> Agregar Mascota</button>
                    </div>
                </div>
            </div>

            <div class="mhm-header-buttons">
                <button class="mhm-btn" onclick="window.print()"><i class="fas fa-print"></i><br>Imprimir</button>
                <button class="mhm-btn" id="btn-save"><i class="fas fa-cloud-upload-alt"></i><br>Guardar</button>
            </div>
        </header>

        <div class="mhm-info-strip">
            <div class="mhm-info-left">
                <div class="mhm-info-pet" id="info-pet-display"><i class="fas fa-paw"></i> Mascota: ...</div>
                <div class="mhm-info-name" id="info-owner">Propietario: ...</div>
                <div class="mhm-info-date" id="info-date">Estado: Sincronizado</div>
            </div>
            <div class="mhm-info-disclaimer">
                </div>
        </div>

        <nav class="mhm-nav-tabs">
            <div class="mhm-tab active" data-tab="pet-info"><i class="fas fa-id-card"></i><br>Datos</div>
            <div class="mhm-tab" data-tab="owner"><i class="fas fa-user"></i><br>Propietario</div>
            <div class="mhm-tab" data-tab="pathologies"><i class="fas fa-notes-medical"></i><br>Patolog√≠as</div>
            <div class="mhm-tab" data-tab="meds"><i class="fas fa-pills"></i><br>Medicinas</div>
            <div class="mhm-tab" data-tab="vaccines"><i class="fas fa-syringe"></i><br>Vacunas</div>
            <div class="mhm-tab" data-tab="vets"><i class="fas fa-user-md"></i><br>Veterinarios</div>
        </nav>

        <main class="mhm-content-panel">

            <div id="tab-pet-info" class="mhm-tab-content active">
                <h2 class="mhm-section-title"><i class="fas fa-paw"></i> Informaci√≥n</h2>
                <div class="mhm-form-row">
                    <div class="mhm-form-group" style="flex: 0 0 180px; align-items: center;">
                        <div class="pet-photo-container" id="pet-photo" title="Toca para cambiar foto">
                            <i class="fas fa-camera" id="photo-icon" style="font-size: 2rem; color: #ccc;"></i>
                            <img id="pet-photo-preview" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                            <div id="photo-loading" class="loading-overlay hidden">
                                <i class="fas fa-spinner fa-spin" style="color: green; font-size: 1.5rem;"></i>
                            </div>
                        </div>
                        <input type="file" id="pet-photo-input" accept="image/*" style="display: none;">
                        <button class="mhm-btn" id="pet-photo-btn" style="margin-top: 10px;">Subir Foto</button>
                    </div>

                    <div class="mhm-form-group mhm-form-group--large">
                        <div class="mhm-form-group"><label class="mhm-label">Nombre</label><input type="text" class="mhm-input" id="pet-name" style="font-size:1.2rem; font-weight:bold;"></div>
                        <div class="mhm-form-group"><label class="mhm-label">Especie</label>
                            <select class="mhm-select" id="pet-species-select">
                                <option value="perro">Perro</option>
                                <option value="gato">Gato</option>
                                <option value="ave">Ave</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="mhm-form-row">
                    <div class="mhm-form-group"><label class="mhm-label">Raza</label><input type="text" class="mhm-input" id="pet-breed"></div>
                    <div class="mhm-form-group"><label class="mhm-label">Color</label><input type="text" class="mhm-input" id="pet-color"></div>
                    <div class="mhm-form-group"><label class="mhm-label">Fecha Nacimiento</label><input type="date" class="mhm-input" id="pet-dob"></div>
                </div>
                <div class="mhm-form-row">
                    <div class="mhm-form-group"><label class="mhm-label">Microchip</label><input type="text" class="mhm-input" id="pet-microchip"></div>
                    <div class="mhm-form-group"><label class="mhm-label">Peso (kg)</label><input type="text" class="mhm-input" id="pet-weight"></div>
                    <div class="mhm-form-group"><label class="mhm-label">Sexo</label>
                        <select class="mhm-select" id="pet-sex">
                            <option value="">Seleccione...</option>
                            <option value="macho">Macho</option>
                            <option value="hembra">Hembra</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="tab-owner" class="mhm-tab-content">
                <h2 class="mhm-section-title"><i class="fas fa-user"></i> Datos del Propietario</h2>
                <div class="mhm-form-row">
                    <div class="mhm-form-group mhm-form-group--large"><label class="mhm-label">Nombre Completo</label><input type="text" class="mhm-input" id="owner-name"></div>
                    <div class="mhm-form-group"><label class="mhm-label">Tel√©fono</label><input type="tel" class="mhm-input" id="owner-phone"></div>
                </div>
                <div class="mhm-form-row">
                    <div class="mhm-form-group mhm-form-group--large"><label class="mhm-label">Direcci√≥n</label><input type="text" class="mhm-input" id="owner-address"></div>
                    <div class="mhm-form-group"><label class="mhm-label">Email</label><input type="email" class="mhm-input" id="owner-email"></div>
                </div>
            </div>

            <div id="tab-pathologies" class="mhm-tab-content">
                <h2 class="mhm-section-title"><i class="fas fa-notes-medical"></i> Historia Cl√≠nica</h2>
                <div class="mhm-card">
                    <label class="mhm-label">Antecedentes, Cirug√≠as y Enfermedades Cr√≥nicas</label>
                    <textarea class="mhm-textarea" id="notes-pathologies" style="height: 200px;" placeholder="Ej: Sufre de displasia de cadera. Operado en 2022..."></textarea>
                </div>
            </div>

            <div id="tab-meds" class="mhm-tab-content">
                <h2 class="mhm-section-title"><i class="fas fa-pills"></i> Medicamentos Activos</h2>
                <div class="mhm-card">
                    <label class="mhm-label">Lista de medicamentos, dosis y frecuencia</label>
                    <textarea class="mhm-textarea" id="notes-meds" style="height: 200px;" placeholder="Ej: Apoquel 16mg - 1 diaria..."></textarea>
                </div>
            </div>

            <div id="tab-vaccines" class="mhm-tab-content">
                <h2 class="mhm-section-title"><i class="fas fa-syringe"></i> Vacunas y Desparasitaci√≥n</h2>
                <div class="mhm-card">
                    <label class="mhm-label">Registro de vacunaci√≥n</label>
                    <textarea class="mhm-textarea" id="notes-vaccines" style="height: 200px;" placeholder="Ej: Rabia - 12/10/2023 (Lote A123)..."></textarea>
                </div>
            </div>

            <div id="tab-vets" class="mhm-tab-content">
                <h2 class="mhm-section-title"><i class="fas fa-user-md"></i> Contactos Veterinarios</h2>
                <div class="mhm-card">
                    <label class="mhm-label">Veterinario Principal y Cl√≠nicas</label>
                    <textarea class="mhm-textarea" id="notes-vets" style="height: 200px;" placeholder="Dr. P√©rez - Cl√≠nica San Francisco..."></textarea>
                </div>
            </div>

        </main>
    </div>

    <script>
        // ============================================
        // GOOGLE SHEETS + DRIVE STORAGE MANAGER
        // ============================================
        class GoogleCloudStorage {
            constructor() {
                // ==================================================
                // CONFIGURACI√ìN (Paso 1)
                // ==================================================
                this.scriptURL = "https://script.google.com/macros/s/AKfycbxIqeThUiJhj298q3zbcOhc8VWiT5yvKlBoxwGqLQTwMEnrIXW5DH9Jhd2LuLS5rddaiA/exec"; 
                // ==================================================

                this.userId = localStorage.getItem('mhm_cloud_id');
                if (!this.userId) {
                    this.userId = 'MHM-' + Math.random().toString(36).substr(2, 4).toUpperCase();
                    localStorage.setItem('mhm_cloud_id', this.userId);
                    setTimeout(() => alert('‚ö†Ô∏è TU ID DE NUBE: ' + this.userId + '\n\nGu√°rdalo. Si la app se reinicia, lo necesitar√°s para recuperar tus datos.'), 2000);
                }
                
                this.renderFooterID();
            }

            renderFooterID() {
                const footer = document.querySelector('.mhm-info-disclaimer');
                if(footer) {
                    const el = document.createElement('div');
                    el.style.cssText = "margin-top:10px; background:#fff3e0; padding:5px; border-radius:4px; text-align:center; color:#e64a19; font-weight:bold;";
                    el.innerHTML = `ID Nube: ${this.userId} <button onclick="recoverData()" style="margin-left:10px; cursor:pointer; background:#333; color:white; border:none; padding:4px 8px; border-radius:4px;">üîÑ Recuperar</button>`;
                    footer.appendChild(el);
                }
                window.recoverData = () => {
                    const code = prompt("Introduce tu ID de Nube anterior:", "");
                    if(code && code.trim().length > 3) {
                        localStorage.setItem('mhm_cloud_id', code.trim().toUpperCase());
                        location.reload();
                    }
                }
            }

            async uploadImage(base64Image) {
                try {
                    const res = await fetch(this.scriptURL, {
                        method: 'POST',
                        mode: 'cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: "uploadImage", image: base64Image })
                    });
                    const json = await res.json();
                    return json.status === "success" ? json.url : null;
                } catch(e) { console.error(e); alert("Error al subir foto a la nube."); return null; }
            }

            async save(data) {
                // Indicador visual
                const dateEl = document.getElementById('info-date');
                if(dateEl) dateEl.innerText = "Estado: ‚òÅÔ∏è Guardando...";
                
                try {
                    await fetch(this.scriptURL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ id: this.userId, data: data })
                    });
                    if(dateEl) dateEl.innerText = "Estado: ‚úÖ Guardado";
                } catch(e) {
                    if(dateEl) dateEl.innerText = "Estado: ‚ùå Error";
                }
            }

            async load() {
                try {
                    const res = await fetch(this.scriptURL + "?action=read&id=" + this.userId);
                    return await res.json();
                } catch(e) { return null; }
            }
        }

        // ============================================
        // LOGICA DE LA APP (Multi-Pet)
        // ============================================
        class PetApp {
            constructor() {
                this.storage = new GoogleCloudStorage();
                this.pets = [];
                this.currentId = null;
                this.init();
            }

            async init() {
                const data = await this.storage.load();
                if (data && Array.isArray(data) && data.length > 0) {
                    this.pets = data;
                } else {
                    this.createDefaultPet();
                }
                this.currentId = this.pets[0].id;
                this.renderUI();
                this.setupEventListeners();
            }

            createDefaultPet() {
                this.pets = [{
                    id: 'pet_' + Date.now(),
                    name: "Mascota 1",
                    data: {
                        petInfo: { name: "Mascota 1", species: "perro", breed:"", color:"", dob:"", microchip:"", weight:"", sex:"", photo:"" },
                        ownerInfo: { name:"", phone:"", address:"", email:"" },
                        notes: { pathologies:"", meds:"", vaccines:"", vets:"" }
                    }
                }];
            }

            getCurrentPet() { return this.pets.find(p => p.id === this.currentId); }

            addPet() {
                if(this.pets.length >= 5) return alert("M√°ximo 5 mascotas.");
                const name = prompt("Nombre de la nueva mascota:");
                if(!name) return;
                
                const newPet = {
                    id: 'pet_' + Date.now(),
                    name: name,
                    data: {
                        petInfo: { name: name, species: "perro", breed:"", color:"", dob:"", microchip:"", weight:"", sex:"", photo:"" },
                        ownerInfo: { name:"", phone:"", address:"", email:"" },
                        notes: { pathologies:"", meds:"", vaccines:"", vets:"" }
                    }
                };
                this.pets.push(newPet);
                this.currentId = newPet.id;
                this.storage.save(this.pets);
                this.renderUI();
            }

            renderUI() {
                const pet = this.getCurrentPet();
                // Actualizar Textos
                document.getElementById('current-pet-name').innerText = pet.name;
                document.getElementById('info-pet-display').innerText = pet.name;
                document.getElementById('info-owner').innerText = "Propietario: " + (pet.data.ownerInfo.name || "‚Äî");
                
                // Render lista dropdown
                const list = document.getElementById('pet-list');
                list.innerHTML = '';
                this.pets.forEach(p => {
                    const item = document.createElement('div');
                    item.className = `pet-item ${p.id === this.currentId ? 'active' : ''}`;
                    item.innerHTML = `<i class="fas fa-paw"></i> ${p.name}`;
                    item.onclick = () => { this.currentId = p.id; this.renderUI(); document.getElementById('pet-selector-dropdown').classList.add('hidden'); };
                    list.appendChild(item);
                });

                // Llenar inputs
                this.fillInputs(pet.data);
                
                // Mostrar foto
                const img = document.getElementById('pet-photo-preview');
                const icon = document.getElementById('photo-icon');
                if(pet.data.petInfo.photo) {
                    img.src = pet.data.petInfo.photo;
                    img.style.display = 'block';
                    icon.style.display = 'none';
                } else {
                    img.style.display = 'none';
                    icon.style.display = 'block';
                }
            }

            fillInputs(d) {
                setVal('pet-name', d.petInfo.name);
                setVal('pet-species-select', d.petInfo.species);
                setVal('pet-breed', d.petInfo.breed);
                setVal('pet-color', d.petInfo.color);
                setVal('pet-dob', d.petInfo.dob);
                setVal('pet-microchip', d.petInfo.microchip);
                setVal('pet-weight', d.petInfo.weight);
                setVal('pet-sex', d.petInfo.sex);
                setVal('owner-name', d.ownerInfo.name);
                setVal('owner-phone', d.ownerInfo.phone);
                setVal('owner-address', d.ownerInfo.address);
                setVal('owner-email', d.ownerInfo.email);
                setVal('notes-pathologies', d.notes.pathologies);
                setVal('notes-meds', d.notes.meds);
                setVal('notes-vaccines', d.notes.vaccines);
                setVal('notes-vets', d.notes.vets);
            }

            saveDataFromInputs() {
                const pet = this.getCurrentPet();
                if(!pet) return;
                
                pet.name = getVal('pet-name'); // Sync name
                pet.data.petInfo = {
                    name: getVal('pet-name'), species: getVal('pet-species-select'),
                    breed: getVal('pet-breed'), color: getVal('pet-color'),
                    dob: getVal('pet-dob'), microchip: getVal('pet-microchip'),
                    weight: getVal('pet-weight'), sex: getVal('pet-sex'),
                    photo: pet.data.petInfo.photo // Keep existing photo URL
                };
                pet.data.ownerInfo = {
                    name: getVal('owner-name'), phone: getVal('owner-phone'),
                    address: getVal('owner-address'), email: getVal('owner-email')
                };
                pet.data.notes = {
                    pathologies: getVal('notes-pathologies'), meds: getVal('notes-meds'),
                    vaccines: getVal('notes-vaccines'), vets: getVal('notes-vets')
                };
                
                this.storage.save(this.pets);
            }

            setupEventListeners() {
                // Auto-save debounce
                let timeout;
                document.querySelectorAll('input, textarea, select').forEach(el => {
                    el.addEventListener('input', () => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => this.saveDataFromInputs(), 1000);
                    });
                });

                // Botones
                document.getElementById('pet-add-btn').onclick = () => this.addPet();
                document.getElementById('btn-save').onclick = () => { this.saveDataFromInputs(); alert("Datos guardados en la nube."); };
                document.getElementById('pet-selector-btn').onclick = (e) => { e.stopPropagation(); document.getElementById('pet-selector-dropdown').classList.toggle('hidden'); };
                document.onclick = () => document.getElementById('pet-selector-dropdown').classList.add('hidden');

                // Tabs
                document.querySelectorAll('.mhm-tab').forEach(t => {
                    t.onclick = () => {
                        document.querySelectorAll('.mhm-tab').forEach(x => x.classList.remove('active'));
                        document.querySelectorAll('.mhm-tab-content').forEach(x => x.classList.remove('active'));
                        t.classList.add('active');
                        document.getElementById('tab-' + t.dataset.tab).classList.add('active');
                    }
                });

                // Foto Logic
                const photoInput = document.getElementById('pet-photo-input');
                const photoLoading = document.getElementById('photo-loading');
                
                document.getElementById('pet-photo').onclick = () => photoInput.click();
                document.getElementById('pet-photo-btn').onclick = () => photoInput.click();

                photoInput.onchange = async (e) => {
                    if (e.target.files && e.target.files[0]) {
                        photoLoading.classList.remove('hidden');
                        const compressed = await compressImage(e.target.files[0], 600);
                        const url = await this.storage.uploadImage(compressed);
                        
                        if(url) {
                            this.getCurrentPet().data.petInfo.photo = url;
                            this.saveDataFromInputs(); // Guardar URL en Sheet
                            this.renderUI();
                        }
                        photoLoading.classList.add('hidden');
                    }
                };
            }
        }

        // Helpers Globales
        function getVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        function setVal(id, val) { const el = document.getElementById(id); if(el) el.value = val || ''; }
        
        function compressImage(file, maxWidth) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h *= maxWidth/w; w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        }

        // INICIAR APP
        const app = new PetApp();

    </script>
</body>
</html>
